# =====================================================
# Romuo.ch - Hostinger Apache Configuration
# Optimise pour hebergement mutualisé Hostinger
# =====================================================

# =====================================================
# 1. RÉÉCRITURE SPA (Single Page Application)
# Toutes les routes dirigées vers index.html
# =====================================================
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Forcer HTTPS
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # Rediriger www vers non-www (optionnel, adapter selon domaine)
  RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
  RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301]

  # SPA Routing - Ne pas réécrire les fichiers/dossiers existants
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ /index.html [QSA,L]
</IfModule>

# =====================================================
# 2. COMPRESSION GZIP
# Réduit la taille des transferts de 60-80%
# =====================================================
<IfModule mod_deflate.c>
  # Compresser HTML, CSS, JavaScript, Text, XML et fonts
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/ld+json
  AddOutputFilterByType DEFLATE application/manifest+json
  AddOutputFilterByType DEFLATE image/svg+xml
  AddOutputFilterByType DEFLATE font/ttf
  AddOutputFilterByType DEFLATE font/otf
  AddOutputFilterByType DEFLATE font/woff
  AddOutputFilterByType DEFLATE font/woff2
  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject

  # Supprimer les bugs de compression pour les anciens navigateurs
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# Servir les fichiers pre-compresses si disponibles
<IfModule mod_rewrite.c>
  RewriteCond %{HTTP:Accept-Encoding} gzip
  RewriteCond %{REQUEST_FILENAME}.gz -f
  RewriteRule ^(.*)$ $1.gz [QSA,L]
</IfModule>

<FilesMatch "\.js\.gz$">
  ForceType application/javascript
  Header set Content-Encoding gzip
</FilesMatch>

<FilesMatch "\.css\.gz$">
  ForceType text/css
  Header set Content-Encoding gzip
</FilesMatch>

# =====================================================
# 3. CACHE NAVIGATEUR (Expires Headers)
# Réduit les requêtes réseau pour les visiteurs récurrents
# =====================================================
<IfModule mod_expires.c>
  ExpiresActive On

  # Default: 1 semaine
  ExpiresDefault "access plus 1 week"

  # HTML - Toujours vérifier (SPA, contenu dynamique)
  ExpiresByType text/html "access plus 0 seconds"

  # CSS et JavaScript (fichiers hashés par Vite)
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/x-javascript "access plus 1 year"

  # Images
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Fonts
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"

  # Manifeste et Service Worker
  ExpiresByType application/manifest+json "access plus 1 week"
  ExpiresByType application/json "access plus 0 seconds"

  # XML
  ExpiresByType application/xml "access plus 0 seconds"
  ExpiresByType text/xml "access plus 0 seconds"
</IfModule>

# Cache-Control headers
<IfModule mod_headers.c>
  # Fichiers hashés par Vite (immutables)
  <FilesMatch "\.[0-9a-f]{8}\.(js|css)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Assets statiques avec hash
  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Images et fonts
  <FilesMatch "\.(ico|jpg|jpeg|png|gif|svg|webp|avif|woff|woff2|ttf|otf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # HTML - Toujours revalider
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires 0
  </FilesMatch>

  # Service Worker - Toujours frais
  <FilesMatch "sw\.js$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires 0
  </FilesMatch>

  # Manifest PWA - Cache court
  <FilesMatch "manifest\.json$">
    Header set Cache-Control "public, max-age=604800"
  </FilesMatch>
</IfModule>

# =====================================================
# 4. HEADERS DE SECURITÉ
# Protection contre les attaques courantes
# =====================================================
<IfModule mod_headers.c>
  # Protection XSS
  Header set X-Content-Type-Options "nosniff"
  Header set X-Frame-Options "SAMEORIGIN"
  Header set X-XSS-Protection "1; mode=block"

  # Referrer Policy
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # Permissions Policy
  Header set Permissions-Policy "camera=(), microphone=(), geolocation=(self), payment=()"

  # Content Security Policy (adapté pour Romuo)
  Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://images.unsplash.com https://*.tile.openstreetmap.org https://cdnjs.cloudflare.com https://unpkg.com; connect-src 'self' https://api.romuo.ch https://*.tile.openstreetmap.org https://nominatim.openstreetmap.org; manifest-src 'self'; worker-src 'self';"

  # Strict Transport Security (HSTS)
  Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# =====================================================
# 5. TYPES MIME
# Assurer le bon type pour tous les fichiers
# =====================================================
<IfModule mod_mime.c>
  # JavaScript
  AddType application/javascript .js .mjs

  # JSON
  AddType application/json .json
  AddType application/manifest+json .webmanifest

  # Fonts
  AddType font/woff .woff
  AddType font/woff2 .woff2
  AddType font/ttf .ttf
  AddType font/otf .otf
  AddType application/vnd.ms-fontobject .eot

  # Images
  AddType image/svg+xml .svg .svgz
  AddType image/webp .webp
  AddType image/avif .avif

  # Web App Manifest
  AddType application/manifest+json .json
</IfModule>

# =====================================================
# 6. PROTECTION DES FICHIERS
# Bloquer l'accès aux fichiers sensibles
# =====================================================

# Bloquer l'accès aux fichiers cachés (sauf .htaccess)
<FilesMatch "^\.(?!htaccess)">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
</FilesMatch>

# Bloquer l'accès aux fichiers de configuration
<FilesMatch "(\.env|\.git|\.bak|\.config|\.sql|\.log)$">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
</FilesMatch>

# =====================================================
# 7. PERFORMANCE SUPPLÉMENTAIRE
# =====================================================

# ETags - Désactiver pour les fichiers statiques (conflit avec CDN)
<IfModule mod_headers.c>
  Header unset ETag
</IfModule>
FileETag None

# Keep-Alive pour réutiliser les connexions
<IfModule mod_headers.c>
  Header set Connection keep-alive
</IfModule>

# Charset UTF-8 par défaut
AddDefaultCharset UTF-8
